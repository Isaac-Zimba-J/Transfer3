<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:Transfer3.Domain.Models"
             xmlns:viewModels="clr-namespace:Transfer3.ViewModels"
             xmlns:helpers="clr-namespace:Transfer3.Helpers"
             x:DataType="viewModels:MainPageViewModel"
             x:Class="Transfer3.MainPage">
    <ContentPage.Resources>
        <ResourceDictionary>
            <helpers:StatusToActivityConverter x:Key="StatusToActivityConverter" />
            <helpers:TimeRemainingConverter x:Key="TimeRemainingConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <ScrollView>
        <VerticalStackLayout Padding="20"
                             Spacing="20">
            <!-- HEADER -->
            <Border Padding="15"
                    BackgroundColor="White"
                    Stroke="{StaticResource Primary}"
                    StrokeThickness="2">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="#000000"
                            Offset="4,4"
                            Radius="8"
                            Opacity="0.25" />
                </Border.Shadow>
                <Grid ColumnDefinitions="*,Auto">
                    <VerticalStackLayout Grid.Column="0"
                                         Spacing="5">
                        <Label Text="This Device"
                               FontAttributes="Bold"
                               FontSize="16" />
                        <Label Text="{Binding CurrentDevice.Name}"
                               FontSize="14" />
                        <Label Text="{Binding CurrentDevice.IpAddress}"
                               FontSize="12"
                               TextColor="Gray" />
                    </VerticalStackLayout>
                    <BoxView Grid.Column="1"
                             WidthRequest="20"
                             HeightRequest="20"
                             CornerRadius="10"
                             VerticalOptions="Center"
                             Color="{Binding IsConnected, Converter={StaticResource BoolToColorConverter}}" />
                </Grid>
            </Border>
            <Label Text="{Binding StatusMessage}"
                   FontSize="14"
                   HorizontalTextAlignment="Center"
                   TextColor="{StaticResource Primary}" />
            <Grid ColumnDefinitions="*,*,*"
                  ColumnSpacing="10">
                <Button Grid.Column="0"
                        Text="Start Discovery"
                        Command="{Binding StartDiscoveryCommand}"
                        IsEnabled="{Binding IsDiscovering, Converter={StaticResource InverseBoolConverter}}" />
                <Button Grid.Column="1"
                        Text="Refresh"
                        Command="{Binding RefreshDevicesCommand}"
                        IsEnabled="{Binding IsDiscovering}" />
                <Button Grid.Column="2"
                        Text="Stop"
                        Command="{Binding StopDiscoveryCommand}"
                        IsEnabled="{Binding IsDiscovering}" />
            </Grid>
            <!-- Devices -->
            <Label Text="Available Devices"
                   FontSize="18"
                   FontAttributes="Bold" />
            <CollectionView ItemsSource="{Binding DiscoveredDevices}"
                            SelectedItem="{Binding SelectedDevice}"
                            SelectionMode="Single"
                            EmptyView="No devices found. Make sure other devices are running the app.">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:DeviceInformation">
                        <Border Padding="15"
                                BackgroundColor="White"
                                Stroke="{StaticResource Primary}"
                                StrokeThickness="1"
                                Margin="0,5">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <Border.Shadow>
                                <Shadow Brush="#000000"
                                        Offset="3,3"
                                        Radius="6"
                                        Opacity="0.18" />
                            </Border.Shadow>
                            <Grid ColumnDefinitions="Auto,*,Auto"
                                  ColumnSpacing="15">
                                <Label Grid.Column="0"
                                       Text="{Binding DeviceType, Converter={StaticResource DeviceTypeToIconConverter}}"
                                       FontSize="32"
                                       VerticalOptions="Center" />
                                <VerticalStackLayout Grid.Column="1"
                                                     Spacing="5">
                                    <Label Text="{Binding Name}"
                                           FontAttributes="Bold"
                                           FontSize="16" />
                                    <Label Text="{Binding IpAddress}"
                                           FontSize="12"
                                           TextColor="Gray" />
                                    <Label Text="{Binding DeviceType}"
                                           FontSize="12"
                                           TextColor="Gray" />
                                </VerticalStackLayout>
                                <BoxView Grid.Column="2"
                                         WidthRequest="15"
                                         HeightRequest="15"
                                         CornerRadius="7.5"
                                         Color="Green"
                                         VerticalOptions="Center"
                                         IsVisible="{Binding IsOnline}" />
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <Button Text="Send File to Selected Device"
                    Command="{Binding SendFileCommand}"
                    HeightRequest="50"
                    FontSize="16"
                    FontAttributes="Bold"
                    Margin="0,10,0,0" />
            <!-- Active Transfers -->
            <Label Text="Active Transfers"
                   FontSize="18"
                   FontAttributes="Bold" />
            <CollectionView ItemsSource="{Binding ActiveTransfers}"
                            EmptyView="No active transfers">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:FileTransferInfo">
                        <Border Padding="15"
                                BackgroundColor="White"
                                StrokeThickness="0"
                                Margin="0,5">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <Border.Shadow>
                                <Shadow Brush="#000000"
                                        Offset="3,3"
                                        Radius="6"
                                        Opacity="0.12" />
                            </Border.Shadow>
                            <VerticalStackLayout Spacing="10">
                                <Label Text="{Binding FileName}"
                                       FontAttributes="Bold"
                                       FontSize="16" />
                                <!-- Transfer Status and Activity Indicator -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0"
                                           Text="{Binding Status}"
                                           FontSize="14"
                                           TextColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                           VerticalOptions="Center" />
                                    <ActivityIndicator Grid.Column="1"
                                                       IsRunning="{Binding Status, Converter={StaticResource StatusToActivityConverter}}"
                                                       Color="{StaticResource Primary}"
                                                       HeightRequest="24"
                                                       WidthRequest="24" />
                                </Grid>
                                <ProgressBar Progress="{Binding Progress, Converter={StaticResource PercentToDecimalConverter}, Mode=TwoWay}"
                                             ProgressColor="{StaticResource Primary}" />
                                <Grid ColumnDefinitions="*,*,*">
                                    <Label Grid.Column="0"
                                           Text="{Binding Progress, StringFormat='{0:F1}%'}"
                                           FontSize="12" />
                                    <Label Grid.Column="1"
                                           Text="{Binding ., Converter={StaticResource TimeRemainingConverter}}"
                                           FontSize="12"
                                           HorizontalOptions="Center"
                                           TextColor="Gray" />
                                    <Label Grid.Column="2"
                                           Text="{Binding TransferSpeed, Converter={StaticResource SpeedConverter}}"
                                           FontSize="12"
                                           HorizontalOptions="End" />
                                </Grid>
                                <Button Text="Cancel"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:MainPageViewModel}}, Path=CancelTransferCommand}"
                                        CommandParameter="{Binding Id}"
                                        BackgroundColor="Red"
                                        TextColor="White"
                                        HeightRequest="40" />
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <!-- History -->
            <Label Text="Transfer History"
                   FontSize="18"
                   FontAttributes="Bold" />
            <CollectionView ItemsSource="{Binding TransferHistory}"
                            EmptyView="No transfer history">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:FileTransferInfo">
                        <Border Padding="15"
                                BackgroundColor="White"
                                StrokeThickness="0"
                                Margin="0,5">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <Border.Shadow>
                                <Shadow Brush="#000000"
                                        Offset="3,3"
                                        Radius="6"
                                        Opacity="0.12" />
                            </Border.Shadow>
                            <VerticalStackLayout Spacing="5">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0"
                                           Text="{Binding FileName}"
                                           FontAttributes="Bold"
                                           FontSize="16" />
                                    <Label Grid.Column="1"
                                           Text="{Binding Status}"
                                           FontSize="12"
                                           TextColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                           VerticalOptions="Center" />
                                </Grid>
                                <Label Text="{Binding StartTime, StringFormat='Started: {0:g}'}"
                                       FontSize="12"
                                       TextColor="Gray" />
                                <Label Text="{Binding DestinationDevice.Name, StringFormat='To: {0}'}"
                                       FontSize="12"
                                       TextColor="Gray" />
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>